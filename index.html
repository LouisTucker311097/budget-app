<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Wallet</title>
<style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
    header { background: #4CAF50; color: white; padding: 10px; text-align: center; font-size: 1.5em; font-weight: bold; }
    .container { padding: 15px; max-width: 900px; margin: auto; }
    .dropdown { background: white; margin-bottom: 10px; border-radius: 8px; overflow: hidden; border: 1px solid #ddd; }
    .dropdown-header { padding: 10px; background: #eee; cursor: pointer; display: flex; justify-content: space-between; font-weight: bold; align-items: center; }
    .dropdown-content { display: none; padding: 10px; }
    .item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #ddd; align-items: center; }
    .delete-btn { cursor: pointer; font-weight: bold; margin-right: 8px; font-size: 12px; color: black; }
    .value { font-weight: bold; }
    .floating-btn { position: fixed; bottom: 20px; right: 20px; background: #4CAF50; color: white; border-radius: 50%; width: 60px; height: 60px; font-size: 2em; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0px 4px 6px rgba(0,0,0,0.2); }
    .popup-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; z-index: 1000; }
    .popup { background: white; padding: 20px; border-radius: 8px; width: 300px; }
    .popup button { width: 100%; padding: 10px; margin: 5px 0; border: none; cursor: pointer; font-size: 1em; border-radius: 5px; background: #4CAF50; color: white; }
    .popup input, .popup select { width: calc(100% - 10px); padding: 8px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; }
    .daily-view { background: white; padding: 10px; border-radius: 8px; border: 1px solid #ddd; }
    .daily-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #ddd; }
    .today { background-color: #fff8b3; border-radius: 4px; }
    .month-display { display: flex; align-items: center; cursor: pointer; font-weight: bold; font-size: 1em; }
    .month-display span { margin-left: 5px; }
    #month-popup-select { width: 200px; max-height: 200px; overflow-y: auto; padding: 5px; border-radius: 5px; border: 1px solid #ddd; font-size: 1em; background: white; position: absolute; z-index: 1001; }
</style>
</head>
<body>

<header>My Wallet</header>

<div class="container">
    <div id="remaining-budget" style="font-size: 1.2em; font-weight: bold; text-align: center; margin-bottom: 10px;">
        <span style="color:black;">Remaining Budget:</span> <span id="remaining-budget-value">£0.00</span>
    </div>

    <div class="dropdown" id="daily-expenses-dropdown">
        <div class="dropdown-header">Daily Expenses <span id="daily-expenses-total">£0.00</span></div>
        <div class="dropdown-content" id="daily-expenses-list"></div>
    </div>

    <div class="dropdown" id="recurring-expenses-dropdown">
        <div class="dropdown-header">Recurring Expenses <span id="recurring-expenses-total">£0.00</span></div>
        <div class="dropdown-content" id="recurring-expenses-list"></div>
    </div>

    <div class="dropdown" id="income-dropdown">
        <div class="dropdown-header">Income <span id="income-total">£0.00</span></div>
        <div class="dropdown-content" id="income-list"></div>
    </div>

    <div class="dropdown" id="daily-view-dropdown">
        <div class="dropdown-header">
            <div class="month-display" id="month-display"> 
                <span id="month-year-text"></span>
                <span>▼</span>
            </div>
            <span id="daily-view-total"></span>
        </div>
        <div class="dropdown-content" id="daily-spending-view"></div>
    </div>
</div>

<div class="floating-btn" id="add-btn">+</div>

<div class="popup-overlay" id="popup-overlay">
    <div class="popup" id="popup-content">
        <button data-type="daily">Daily Expense</button>
        <button data-type="recurring">Recurring Expense</button>
        <button data-type="income">Income</button>
    </div>
</div>

<script>
const storageKey = "myWalletData";
let data = JSON.parse(localStorage.getItem(storageKey)) || { daily: [], recurring: [], income: [] };
const remainingBudgetValueEl = document.getElementById("remaining-budget-value");
const popupOverlay = document.getElementById("popup-overlay");
const popupContent = document.getElementById("popup-content");

let currentDate = new Date();
let currentMonth = currentDate.getMonth();
let currentYear = currentDate.getFullYear();

function saveData() {
    localStorage.setItem(storageKey, JSON.stringify(data));
    render();
}

function toggleDropdown(header, content) {
    content.style.display = content.style.display === "block" ? "none" : "block";
}

function createItemRow(name, value, type, date, index) {
    const itemDiv = document.createElement("div");
    itemDiv.classList.add("item");

    const deleteBtn = document.createElement("span");
    deleteBtn.textContent = "✖";
    deleteBtn.classList.add("delete-btn");
    deleteBtn.onclick = () => {
        data[type].splice(index, 1);
        saveData();
    };

    const nameSpan = document.createElement("span");
    nameSpan.textContent = name;
    nameSpan.style.flex = "1";

    const valueSpan = document.createElement("span");
    if(type === "daily" || type === "recurring") value = -Math.abs(parseFloat(value));
    else value = parseFloat(value);
    valueSpan.textContent = `£${parseFloat(value).toFixed(2)}`;
    valueSpan.style.color = value > 0 ? 'green' : value < 0 ? 'red' : 'black';

    itemDiv.appendChild(deleteBtn);
    itemDiv.appendChild(nameSpan);
    itemDiv.appendChild(valueSpan);
    return itemDiv;
}

// Helper function to get array of dates between two dates
function getDatesBetween(start, end) {
    const dates = [];
    const dt = new Date(start);
    while(dt <= end){
        dates.push(new Date(dt));
        dt.setDate(dt.getDate() + 1);
    }
    return dates;
}

// Calculate daily budgets with carryover — UPDATED for 31-day rolling from payday
function calculateDailyBudgets() {
    const dailyBudgets = {};
    if(data.income.length === 0) return dailyBudgets;

    const income = data.income[0]; // assume single income
    const payday = new Date(income.date);
    const periodStart = new Date(payday);
    const periodEnd = new Date(payday);
    periodEnd.setDate(periodEnd.getDate() + 30); // 31-day period including payday

    // Get all dates in the 31-day period
    const days = getDatesBetween(periodStart, periodEnd);

    // Sum recurring expenses within this period
    let recurringTotal = 0;
    data.recurring.forEach(exp => {
        const start = new Date(exp.startDate);
        const end = exp.endDate ? new Date(exp.endDate) : periodEnd;
        if(end >= periodStart && start <= periodEnd){
            recurringTotal += parseFloat(exp.value);
        }
    });

    const monthlyIncome = parseFloat(income.value);
    const netIncome = monthlyIncome - recurringTotal;
    const baseDailyBudget = netIncome / days.length;

    let previousCarryOver = 0;
    days.forEach(d => {
        const dateStr = d.toISOString().split("T")[0];
        const spentRecord = data.daily.find(rec => rec.date === dateStr);
        const spent = spentRecord ? Math.abs(parseFloat(spentRecord.value)) : 0;
        let budget = baseDailyBudget + previousCarryOver - spent;
        dailyBudgets[dateStr] = budget;
        previousCarryOver = budget;
    });

    return dailyBudgets;
}

function render() {
    const dailyList = document.getElementById("daily-expenses-list");
    const recurringList = document.getElementById("recurring-expenses-list");
    const incomeList = document.getElementById("income-list");

    dailyList.innerHTML = "";
    recurringList.innerHTML = "";
    incomeList.innerHTML = "";

    let dailyTotal = 0, recurringTotal = 0, incomeTotal = 0;

    const filteredDaily = data.daily.filter(item => {
        const d = new Date(item.date);
        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
    });
    filteredDaily.forEach((item, i) => {
        dailyList.appendChild(createItemRow(item.name, item.value, "daily", item.date, i));
        dailyTotal += -Math.abs(parseFloat(item.value));
    });

    const filteredRecurring = data.recurring.filter(item => {
        const start = new Date(item.startDate);
        const end = item.endDate ? new Date(item.endDate) : null;
        const monthStart = new Date(currentYear, currentMonth, 1);
        const monthEnd = new Date(currentYear, currentMonth + 1, 0);
        return (start <= monthEnd) && (!end || end >= monthStart);
    });
    filteredRecurring.forEach((item, i) => {
        recurringList.appendChild(createItemRow(item.name, item.value, "recurring", item.startDate, i));
        recurringTotal += -Math.abs(parseFloat(item.value));
    });

    const filteredIncome = data.income.filter(item => {
        const d = new Date(item.date);
        return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
    });
    filteredIncome.forEach((item, i) => {
        incomeList.appendChild(createItemRow(item.name, item.value, "income", item.date, i));
        incomeTotal += parseFloat(item.value);
    });

    function colorByValue(val) {
        if (val > 0) return 'green';
        if (val < 0) return 'red';
        return 'black';
    }

    document.getElementById("daily-expenses-total").textContent = `£${dailyTotal.toFixed(2)}`;
    document.getElementById("daily-expenses-total").style.color = colorByValue(dailyTotal);
    document.getElementById("recurring-expenses-total").textContent = `£${recurringTotal.toFixed(2)}`;
    document.getElementById("recurring-expenses-total").style.color = colorByValue(recurringTotal);
    document.getElementById("income-total").textContent = `£${incomeTotal.toFixed(2)}`;
    document.getElementById("income-total").style.color = colorByValue(incomeTotal);

    const remaining = incomeTotal + recurringTotal + dailyTotal;
    remainingBudgetValueEl.textContent = `£${remaining.toFixed(2)}`;
    remainingBudgetValueEl.style.color = colorByValue(remaining);

    renderDailySpendingView();
}

function renderDailySpendingView() {
    const view = document.getElementById("daily-spending-view");
    view.innerHTML = "";

    const today = new Date();
    today.setHours(0,0,0,0);

    let startDate = new Date(currentYear, currentMonth, 1);
    let endDate = new Date(currentYear, currentMonth + 1, 0);
    const allDates = getDatesBetween(startDate, endDate);

    const dailyBudgets = calculateDailyBudgets();

    allDates.forEach(date => {
        const dateStr = date.toISOString().split("T")[0];
        const spentRecord = data.daily.find(rec => rec.date === dateStr);
        const spent = spentRecord ? -parseFloat(spentRecord.value) : 0;
        const budgetDisplay = date < today ? spent : (dailyBudgets[dateStr] || 0);

        const div = document.createElement("div");
        div.classList.add("daily-item");
        if(date.getTime() === today.getTime()) div.classList.add("today");

        let color;
        if(date < today) {
            color = 'grey'; // Past dates grey
        } else {
            color = budgetDisplay > 0 ? 'green' : budgetDisplay < 0 ? 'red' : 'black';
        }

        const options = { day: '2-digit', month: 'short', year: '2-digit' };
        div.innerHTML = `<span style="color:${color}">${date.toLocaleDateString('en-GB', options)}</span><span style="color:${color}">£${budgetDisplay.toFixed(2)}</span>`;
        view.appendChild(div);
    });

    const monthText = document.getElementById("month-year-text");
    monthText.textContent = startDate.toLocaleDateString('en-GB', { month:'long', year:'numeric' });

    const totalSpan = document.getElementById("daily-view-total");
    totalSpan.textContent = remainingBudgetValueEl.textContent;
    totalSpan.style.color = remainingBudgetValueEl.style.color;
}

// Month selector with <select>
const monthDisplay = document.getElementById("month-display");
let monthPopupSelect = null;

monthDisplay.addEventListener("click", (e) => {
    e.stopPropagation();
    if(monthPopupSelect) return;
    monthPopupSelect = document.createElement("select");
    monthPopupSelect.id = "month-popup-select";
    monthPopupSelect.size = 5;
    const pastMonths = 24;
    const futureMonths = 36;
    for(let i=-pastMonths; i<futureMonths; i++){
        const dt = new Date(currentYear, currentMonth + i, 1);
        const option = document.createElement("option");
        option.value = dt.getMonth() + "-" + dt.getFullYear();
        option.textContent = dt.toLocaleDateString('en-GB', { month:'long', year:'numeric' });
        if(i===0) option.selected = true;
        monthPopupSelect.appendChild(option);
    }

    const rect = monthDisplay.getBoundingClientRect();
    monthPopupSelect.style.top = rect.bottom + "px";
    monthPopupSelect.style.left = rect.left + "px";

    monthPopupSelect.addEventListener("change", () => {
        const [month, year] = monthPopupSelect.value.split("-").map(Number);
        currentMonth = month;
        currentYear = year;
        document.body.removeChild(monthPopupSelect);
        monthPopupSelect = null;
        render();
    });

    document.body.appendChild(monthPopupSelect);
});

// Close month select when clicking outside
document.addEventListener("click", (e) => {
    if(monthPopupSelect && !monthPopupSelect.contains(e.target) && e.target.id !== "month-display" && !monthDisplay.contains(e.target)){
        document.body.removeChild(monthPopupSelect);
        monthPopupSelect = null;
    }
});

// Dropdown toggles
document.querySelectorAll(".dropdown-header").forEach(header => {
    header.addEventListener("click", () => {
        toggleDropdown(header, header.nextElementSibling);
    });
});

// Add button popup
document.getElementById("add-btn").onclick = () => {
    popupOverlay.style.display = "flex";
    popupContent.innerHTML = `
        <button data-type="daily">Daily Expense</button>
        <button data-type="recurring">Recurring Expense</button>
        <button data-type="income">Income</button>
    `;
    popupContent.querySelectorAll("button").forEach(btn => {
        btn.onclick = () => {
            const type = btn.dataset.type;
            if(type === "recurring"){
                popupContent.innerHTML = `
                    <input placeholder="Name" id="name-input">
                    <input placeholder="Value" id="value-input">
                    <label>Start Date</label>
                    <input type="date" id="start-input" value="${new Date().toISOString().split('T')[0]}">
                    <label>End Date (optional)</label>
                    <input type="date" id="end-input">
                    <button id="save-btn">Save</button>
                `;
            } else if(type === "income"){
                if(data.income.length >= 1){
                    alert("Only one income allowed.");
                    popupOverlay.style.display = "none";
                    return;
                }
                popupContent.innerHTML = `
                    <input placeholder="Name" id="name-input">
                    <input type="date" id="date-input" value="${new Date().toISOString().split('T')[0]}">
                    <input placeholder="Value" id="value-input">
                    <button id="save-btn">Save</button>
                `;
            } else {
                popupContent.innerHTML = `
                    <input placeholder="Name" id="name-input">
                    <input type="date" id="date-input" value="${new Date().toISOString().split('T')[0]}">
                    <input placeholder="Value" id="value-input">
                    <button id="save-btn">Save</button>
                `;
            }

            const valueInput = document.getElementById("value-input");
            valueInput.addEventListener("input", (e) => {
                e.target.value = e.target.value.replace(/[^0-9.]/g,'');
                if(e.target.value && !e.target.value.startsWith("£")){
                    e.target.value = "£" + e.target.value.replace(/£/g,"");
                }
            });

            document.getElementById("save-btn").onclick = () => {
                const name = document.getElementById("name-input").value;
                let value = document.getElementById("value-input").value.replace("£","");
                if(!name || !value) return;
                if(type === "recurring"){
                    const start = document.getElementById("start-input").value;
                    const end = document.getElementById("end-input").value || null;
                    if(!start) return;
                    data[type].push({ name, value, startDate: start, endDate: end });
                } else {
                    const date = document.getElementById("date-input").value;
                    if(!date) return;
                    data[type].push({ name, value, date });
                }
                saveData();
                popupOverlay.style.display = "none";
            };
        };
    });
};

popupOverlay.addEventListener("click", (e) => {
    if(e.target === popupOverlay){
        popupOverlay.style.display = "none";
    }
});

render();
</script>
</body>
</html>
